<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Билеты ПДД 2025</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:Arial;margin:0;padding:20px;background:#0e1626;color:#fff;text-align:center}
    h1{font-size:24px;margin:10px 0 20px}
    #progress{font-size:18px;margin:15px}
    #question{font-size:20px;margin:30px 10px;line-height:1.5}
    .ans{background:#1e2a44;margin:12px;padding:16px;border-radius:12px;cursor:pointer}
    .ans:hover{background:#2a3a66}
    .correct{background:#0f8519!important}
    .wrong{background:#c42b1c!important}
    #result{font-size:26px;margin:30px;font-weight:bold}
    button{padding:14px 30px;margin:10px;background:#007bff;color:#fff;border:none;border-radius:10px;font-size:18px}
    img{max-width:100%;border-radius:10px;margin:15px 0}
    #tip{display:none;background:#fff;color:#000;padding:10px;border-radius:10px;margin:10px;text-align:left}
  </style>
</head>
<body>
  <h1>Билеты ПДД 2025</h1>
  <div id="progress">Билет <span id="ticket">1</span>/40 · Вопрос <span id="qnum">1</span>/20</div>
  <div id="question"></div>
  <img id="qimg" style="display:none">
  <div id="answers"></div>
  <div id="result"></div>
  <div id="tip"></div>
  <button onclick="nextQuestion()">Следующий →</button>
  <button onclick="finishTicket()">Завершить билет</button>

  <script>
    Telegram.WebApp.ready(); Telegram.WebApp.expand();

    let tickets = [], currentTicket = 0, currentQuestion = 0, correct = 0, answered = false;
    const baseURL = '/images/'; // Vercel: /public/images/ → /images/

    // Загружаем билеты 1-40 асинхронно
    async function loadTickets() {
      tickets = [];
      for (let i = 1; i <= 40; i++) {
        try {
          const res = await fetch(`/tickets/${i}.json`);
          tickets.push(await res.json()); // Массив вопросов
        } catch (e) { console.error(`Билет ${i} не загружен`); }
      }
      if (tickets.length) loadQuestion();
    }

    function loadQuestion() {
      if (!tickets.length) return;
      const qData = tickets[currentTicket][currentQuestion];
      document.getElementById("ticket").innerText = currentTicket + 1;
      document.getElementById("qnum").innerText = currentQuestion + 1;
      document.getElementById("question").innerHTML = qData.question;
      const img = document.getElementById("qimg");
      if (qData.image) {
        let imgPath = qData.image.replace('./images/', baseURL);
        img.src = imgPath;
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
      document.getElementById("answers").innerHTML = qData.answers.map((a, i) =>
        `<div class="ans" onclick="check(${i})">${a.answer_text}</div>`
      ).join("");
      document.getElementById("result").innerText = "";
      document.getElementById("tip").style.display = 'none';
      answered = false;
    }

    window.check = function(selected) {
      if (answered) return;
      answered = true;
      const qData = tickets[currentTicket][currentQuestion];
      const answers = document.querySelectorAll(".ans");
      let corrIndex = qData.answers.findIndex(a => a.is_correct);
      answers.forEach((el, i) => {
        if (i === corrIndex) el.classList.add("correct");
        else if (i === selected) el.classList.add("wrong");
      });
      if (selected === corrIndex) correct++;
      setTimeout(() => {
        document.getElementById("tip").innerText = qData.answer_tip || qData.correct_answer || '';
        document.getElementById("tip").style.display = 'block';
      }, 500);
    }

    function nextQuestion() {
      if (!answered) return alert("Выберите ответ!");
      currentQuestion++;
      if (currentQuestion >= 20) {
        finishTicket();
      } else {
        loadQuestion();
      }
    }

    function finishTicket() {
      const percent = Math.round(correct / 20 * 100);
      const text = correct >= 18 ? `СДАНО! ✅ ${correct}/20` : `НЕ СДАНО ❌ ${correct}/20 (нужно ≥18)`;
      document.getElementById("result").innerHTML = `<div>${text}</div><div>Ошибок: ${20 - correct}</div>`;
      Telegram.WebApp.MainButton.setText("Новый билет").show().onClick(() => {
        currentTicket = (currentTicket + 1) % 40;
        currentQuestion = 0; correct = 0;
        Telegram.WebApp.MainButton.hide();
        loadQuestion();
      });
    }

    loadTickets();
  </script>
</body>
</html>